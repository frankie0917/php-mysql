<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>test-todo</title>
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<form id="form">
			<h2>Todo</h2>
			<label>
				<span>标题</span>
				<input type="text" class="input-title" />
			</label>
			<label>
				<span>内容</span>
				<input type="text" class="input-content" />
				<span class="id" hidden>123</span>
			</label>
			<label>
				<button type="submit">添加</button>
			</label>
		</form>
		<div class="output">
			<form id="searchForm">
				<input type="text" class="input-search" />
				<button type="submit">搜索</button>
			</form>
			<div class="Thead">
				<div>ID</div>
				<div>Title</div>
				<div>Content</div>
				<div>Time</div>
				<div>Operation</div>
			</div>
			<div class="Tbody"></div>
			<div class="php"></div>
		</div>
	</body>
</html>
<script>
	let datalist;
	boot();

	function boot() {
		read();

		let formEl = document.querySelector("#form");

		formEl.addEventListener("submit", e => {
			e.preventDefault();
			submitAction();
		});

		let searchFormEl = document.querySelector("#searchForm");

		searchFormEl.addEventListener("submit", e => {
			e.preventDefault();
			read();
		});
	}

	function read() {
		let searchData = document.querySelector(".input-search").value;
		let action = "read";
		let data;
		let phpEl = document.querySelector(".php");

		if (searchData) {
			action = "search";
			data = { query: searchData };
		}

		httpRe(
			re => {
				if (re == "error[]") {
					
					phpEl.innerHTML = "没有这条数据";
					return;
				}
				
				let TbodyEl = document.querySelector(".Tbody");
				TbodyEl.innerHTML = "";

				// phpEl.innerHTML = re;
				// console.log(re);
				// return;
				phpEl.innerHTML = "";
				datalist = JSON.parse(re);

				datalist.forEach(ele => {
					let row = document.createElement("div");
					row.classList.add("row");

					row.innerHTML = `
					<span>${ele["id"]}</span>
					<span>${ele["title"]}</span>
					<span>${ele["content"]}</span>
					<span>${ele["created_time"]}</span>
					<span class="operation">
						<button onclick="remove(${ele["id"]})">Del</button>
						<button onclick="update(${ele["id"]})">Update</button>
					</span>
				`;

					TbodyEl.appendChild(row);
				});
			},
			action,
			data
		);
	}

	function submitAction() {
		let titleEl = document.querySelector(".input-title");
		let contentEl = document.querySelector(".input-content");
		let idEl = document.querySelector(".id");
		let id = idEl.innerHTML;

		if (!titleEl.value) return;

		let action = "add";
		let dataObj = {
			title: titleEl.value,
			content: contentEl.value
		};

		if (id) {
			action = "update";
			dataObj["id"] = id;
		}

		httpRe(
			re => {
				read();
				if (action == "update") {
					titleEl.value = "";
					contentEl.value = "";
					idEl.innerHTML = "";
				}
			},
			action,
			dataObj
		);
	}

	function remove(id) {
		httpRe(
			re => {
				read();
			},
			"remove",
			{ id }
		);
	}

	function update(id) {
		let idEl = document.querySelector(".id");
		let titleEl = document.querySelector(".input-title");
		let contentEl = document.querySelector(".input-content");
		let target = datalist.find(ele => {
			return ele.id == id;
		});

		idEl.innerHTML = target.id;
		titleEl.value = target.title;
		contentEl.value = target.content;
	}

	function httpRe(callBack, action, data) {
		if (window.XMLHttpRequest) {
			// code for IE7+, Firefox, Chrome, Opera, Safari
			xmlhttp = new XMLHttpRequest();
		} else {
			// code for IE6, IE5
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		}

		if (action == "read" || action == "search") {
			let url = "test.php?q=" + action;
			if (action == "search") {
				url += `&data=${JSON.stringify(data)}`;
			}

			xmlhttp.open("GET", url, true);
			xmlhttp.send();
		} else if (
			action == "add" ||
			action == "remove" ||
			action == "update"
		) {
			xmlhttp.open("POST", "test.php", true);
			xmlhttp.setRequestHeader(
				"Content-type",
				"application/x-www-form-urlencoded"
			);
			xmlhttp.send(`q=${action}&data=${JSON.stringify(data)}`);
		}

		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				callBack(this.responseText);
			}
		};
	}
</script>
